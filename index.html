<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiore Di Ale - Cat√°logo</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- NUEVA PALETA DE COLORES "FIORE DI ALE" --- */
        :root {
            --fiore-bg-light: #F0EDEB;      /* Fondo principal muy claro */
            --fiore-beige: #D9D0CE;         /* Elementos secundarios, bordes suaves */
            --fiore-pink: #EFA2A5;          /* Acentos vibrantes, barra de progreso */
            --fiore-mauve: #A76678;         /* Botones secundarios, texto suave */
            --fiore-burgundy: #6B2E3E;      /* Color principal, t√≠tulos, botones fuertes */
            
            --text-dark: var(--fiore-burgundy);
            --text-soft: var(--fiore-mauve);
            --card-white: #FFFFFF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        /* Clase para la tipograf√≠a del logo */
        .serif-font { font-family: 'Playfair Display', serif; }

        body { background-color: var(--fiore-bg-light); display: flex; justify-content: center; min-height: 100vh; }

        .app-container {
            width: 100%; background-color: var(--card-white);
            min-height: 100vh; position: relative; padding-bottom: 160px; /* M√°s espacio abajo para la barra de progreso */
            box-shadow: 0 0 30px rgba(107, 46, 62, 0.05);
        }

        /* Responsive Container (Tablet/PC) */
        @media (min-width: 768px) {
            .app-container {
                max-width: 1200px; margin: 30px; border-radius: 30px;
                min-height: calc(100vh - 60px); overflow: hidden;
                box-shadow: 0 15px 50px rgba(107, 46, 62, 0.1);
                padding-bottom: 140px;
            }
        }

        /* HEADER */
        header {
            display: flex; flex-direction: column; align-items: center;
            padding: 25px; background-color: white;
            position: sticky; top: 0; z-index: 20;
            border-bottom: 1px solid var(--fiore-beige);
        }
        @media (min-width: 768px) { header { flex-direction: row; justify-content: space-between; padding: 25px 50px; } }

        /* Nuevo T√≠tulo con tipograf√≠a elegante */
        .header-title { 
            font-weight: 700; font-size: 32px; color: var(--fiore-burgundy); 
            letter-spacing: -0.5px; line-height: 1;
        }
        .header-subtitle { font-size: 12px; color: var(--fiore-mauve); letter-spacing: 1px; margin-top: 5px; text-transform: uppercase; }

        .whatsapp-info { 
            display: flex; align-items: center; gap: 8px; margin-top: 15px; 
            font-size: 14px; color: var(--text-soft); font-weight: 500; text-decoration: none;
            background: var(--fiore-bg-light); padding: 8px 20px; border-radius: 30px;
            transition: 0.3s; border: 1px solid var(--fiore-beige);
        }
        .whatsapp-info:hover { background: var(--fiore-beige); color: var(--fiore-burgundy); }
        .whatsapp-info i { color: #25D366; font-size: 18px; }

        /* ESTADO */
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 15px; border-radius: 20px;
            font-size: 11px; font-weight: 600; margin: 10px 0;
            background: var(--fiore-bg-light); color: var(--text-soft);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #ccc; }
        .status-open .status-dot { background-color: #10B981; animation: pulse-green 2s infinite; }
        .status-open { color: #065f46; background: #D1FAE5; border: 1px solid #10B981; }
        .status-closed .status-dot { background-color: var(--fiore-burgundy); }
        .status-closed { color: var(--fiore-burgundy); background: var(--fiore-bg-light); border: 1px solid var(--fiore-burgundy); }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        /* BUSCADOR */
        .search-container { padding: 15px 20px; background-color: white; position: sticky; top: 105px; z-index: 19; }
        @media (min-width: 768px) { .search-container { top: 100px; padding: 20px 50px; } }
        .search-box {
            display: flex; align-items: center; background-color: var(--fiore-bg-light);
            border: 1px solid var(--fiore-beige); border-radius: 15px; padding: 12px 20px;
            max-width: 600px; margin: 0 auto; transition: 0.3s;
        }
        .search-box:focus-within { border-color: var(--fiore-mauve); background-color: white; }
        .search-box i { color: var(--fiore-mauve); margin-right: 15px; }
        .search-box input { border: none; background: transparent; outline: none; width: 100%; font-size: 14px; color: var(--text-dark); }

        /* HERO */
        .hero { padding: 30px 20px; text-align: center; }
        .hero h1 { font-size: 36px; color: var(--text-dark); line-height: 1.2; }
        .hero h1 span { color: var(--fiore-mauve); font-style: italic; }
        .hero p { color: var(--text-soft); font-size: 15px; margin-top: 10px; }

        /* FILTROS */
        .filter-wrapper { position: relative; display: flex; align-items: center; padding: 15px 5px; justify-content: center; }
        .scroll-arrow { background: white; border: 1px solid var(--fiore-beige); width: 40px; height: 40px; border-radius: 50%; color: var(--fiore-burgundy); z-index: 5; cursor: pointer; display: flex; align-items: center; justify-content: center; transition:0.3s; }
        .scroll-arrow:hover { background: var(--fiore-burgundy); color: white; border-color: var(--fiore-burgundy); }
        .filters { 
            display: flex; gap: 10px; overflow-x: auto; scroll-behavior: smooth; 
            padding: 10px; width: 100%; max-width: 900px; scrollbar-width: none; cursor: grab; 
        }
        .filters.active { cursor: grabbing; }
        .filters::-webkit-scrollbar { display: none; }
        .filter-btn { 
            padding: 10px 25px; border-radius: 30px; border: 1px solid var(--fiore-beige); 
            background: white; color: var(--text-dark); font-size: 14px; font-weight: 500; 
            cursor: pointer; white-space: nowrap; transition: 0.3s; user-select: none;
        }
        .filter-btn:hover { background-color: var(--fiore-bg-light); border-color: var(--fiore-mauve); }
        .filter-btn.active { background-color: var(--fiore-burgundy); color: white; border-color: var(--fiore-burgundy); transform: scale(1.05); box-shadow: 0 5px 15px rgba(107, 46, 62, 0.2); }

        /* GRILLA & CARDS */
        .product-grid { display: grid; gap: 20px; padding: 20px; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 600px) { .product-grid { grid-template-columns: repeat(3, 1fr); gap: 25px; padding: 30px 50px; } }
        @media (min-width: 1024px) { .product-grid { grid-template-columns: repeat(4, 1fr); gap: 30px; } }
        
        .card { 
            background: white; border-radius: 20px; overflow: hidden; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid var(--fiore-beige); 
            display: flex; flex-direction: column; transition: 0.3s; 
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(107, 46, 62, 0.1); border-color: var(--fiore-mauve); }
        .card.selected { border: 2px solid var(--fiore-burgundy); background-color: var(--fiore-bg-light); }
        
        /* Dimensionamiento de im√°genes consistente */
        .card-image-container { height: 180px; width: 100%; position: relative; cursor: pointer; overflow: hidden; background: var(--fiore-bg-light); }
        @media (min-width: 768px) { .card-image-container { height: 240px; } }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: 0.6s; }
        .card:hover .card-img { transform: scale(1.08); }
        
        .reveal { opacity: 0; transform: translateY(30px); transition: all 0.6s ease-out; }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        
        .badge { position: absolute; top: 12px; padding: 5px 12px; border-radius: 12px; font-size: 10px; font-weight: 700; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.05); letter-spacing: 0.5px; }
        .badge-bestseller { left: 12px; background: rgba(255,255,255,0.95); color: var(--fiore-burgundy); }
        .badge-discount { right: 12px; background: var(--fiore-pink); color: var(--fiore-burgundy); }
        
        .card-content { padding: 18px; display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; }
        .card-title { font-size: 15px; font-weight: 600; color: var(--text-dark); margin-bottom: 10px; line-height: 1.3; }
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .price { color: var(--fiore-burgundy); font-weight: 700; font-size: 18px; }
        .old-price { font-size: 13px; text-decoration: line-through; color: var(--text-soft); }
        
        .btn-select { 
            width: 100%; padding: 12px; background-color: white; color: var(--fiore-burgundy); 
            border: 1px solid var(--fiore-burgundy); border-radius: 12px; 
            font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; 
        }
        .btn-select.active { background-color: var(--fiore-burgundy); color: white; }
        .btn-select:hover { background-color: var(--fiore-burgundy); color: white; }

        /* MODAL */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(107, 46, 62, 0.4); align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background-color: white; margin: 0; padding: 0; border-radius: 30px;
            width: 90%; max-width: 480px; position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideUp 0.4s ease;
        }
        @media (min-width: 768px) { .modal-content { max-width: 550px; } }
        @keyframes slideUp { from {transform: translateY(50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal-img { width: 100%; height: 380px; object-fit: cover; }
        .modal-body { padding: 30px; text-align: left; }
        .modal-title { font-size: 24px; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
        .modal-price { font-size: 28px; color: var(--fiore-burgundy); font-weight: 700; margin-bottom: 20px; }
        .modal-desc { font-size: 15px; color: var(--text-soft); line-height: 1.7; margin-bottom: 25px; white-space: pre-wrap; }
        
        .close-modal {
            position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.8); width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: var(--text-dark); cursor: pointer; backdrop-filter: blur(5px); transition: 0.3s;
        }
        .close-modal:hover { background: white; transform: rotate(90deg); }

        /* --- NUEVA BARRA DE PROGRESO GAMIFICADA (TIPO TEMU) --- */
        .discount-progress-container {
            position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 350px; background: white; padding: 12px 20px;
            border-radius: 20px; box-shadow: 0 -5px 20px rgba(107, 46, 62, 0.1);
            z-index: 89; transition: 0.3s; opacity: 0; pointer-events: none;
            border: 1px solid var(--fiore-beige);
        }
        .discount-progress-container.visible { opacity: 1; pointer-events: all; bottom: 95px; }
        /* Estado cuando se logra el objetivo */
        .discount-progress-container.achieved { background: var(--fiore-pink); border-color: var(--fiore-pink); }
        .discount-progress-container.achieved .progress-info span { color: var(--fiore-burgundy); font-weight: 700; }
        .discount-progress-container.achieved .progress-track { background: rgba(255,255,255,0.3); }
        .discount-progress-container.achieved .progress-fill { background: var(--fiore-burgundy); }

        .progress-info { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-soft); margin-bottom: 8px; font-weight: 600; }
        .progress-track { width: 100%; height: 10px; background-color: var(--fiore-bg-light); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--fiore-pink); width: 0%; transition: width 0.5s ease; border-radius: 10px; }

        /* FLOTANTE WHATSAPP */
        .whatsapp-float { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 350px; background-color: #25D366; 
            color: white; padding: 15px 25px; border-radius: 50px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4); 
            cursor: pointer; z-index: 90; opacity: 0; pointer-events: none; transition: 0.3s; 
        }
        .whatsapp-float:hover { transform: translateX(-50%) scale(1.03); background-color: #20bd5a; }
        .whatsapp-float.visible { opacity: 1; pointer-events: all; bottom: 30px; }

        /* LOADER */
        .loader-container { text-align: center; padding: 60px; color: var(--fiore-mauve); }
        .spinner {
            border: 4px solid var(--fiore-bg-light); border-left-color: var(--fiore-pink);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .footer-social { text-align: center; padding: 50px 20px; background: white; margin-top: 30px; border-top: 1px solid var(--fiore-beige); }
        .social-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--fiore-bg-light); display: flex; align-items: center; justify-content: center; color: var(--fiore-mauve); transition: 0.3s; cursor: pointer; border: 1px solid transparent; }
        .social-btn:hover { background: white; color: var(--fiore-burgundy); border-color: var(--fiore-burgundy); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <div class="header-title serif-font">Fiore Di Ale</div>
                <div class="header-subtitle">Flores y Detalles</div>
                
                <div id="businessStatus" class="status-badge">
                    <div class="status-dot"></div>
                    <span id="statusText">Cargando horario...</span>
                </div>
            </div>
            
            <a href="https://wa.me/51977414678" target="_blank" class="whatsapp-info">
                <i class="fab fa-whatsapp"></i> Soporte WhatsApp
            </a>
        </header>

        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar detalles..." onkeyup="handleSearch()">
            </div>
        </div>

        <section class="hero">
            <h1 class="serif-font">Detalles que <span>Enamoran</span></h1>
            <p>Creamos momentos √∫nicos con flores seleccionadas.</p>
        </section>

        <div class="filter-wrapper">
            <button class="scroll-arrow" onclick="scrollContainer(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="filters" id="filtersContainer">
                <button class="filter-btn active" onclick="filterProducts('all', this)">Todos</button>
                <button class="filter-btn" onclick="filterProducts('rosas', this)">Rosas</button>
                <button class="filter-btn" onclick="filterProducts('girasoles', this)">Girasoles</button>
                <button class="filter-btn" onclick="filterProducts('tulipanes', this)">Tulipanes</button>
                <button class="filter-btn" onclick="filterProducts('box', this)">Box</button>
                <button class="filter-btn" onclick="filterProducts('extras', this)">Extras</button>
            </div>
            <button class="scroll-arrow" onclick="scrollContainer(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="product-grid" id="productGrid">
            <div class="loader-container" style="grid-column: 1/-1;">
                <div class="spinner"></div>
                <p>Cargando cat√°logo...</p>
            </div>
        </div>

        <div class="footer-social">
            <div style="font-weight: 600; font-size: 14px; color: var(--fiore-burgundy); margin-bottom: 20px; letter-spacing: 1px;">S√çGUENOS</div>
            <div class="social-icons" style="display:flex; justify-content:center; gap:20px; margin-bottom:25px;">
                <div class="social-btn"><i class="fab fa-instagram"></i></div>
                <div class="social-btn"><i class="fab fa-facebook-f"></i></div>
                <div class="social-btn"><i class="fab fa-tiktok"></i></div>
            </div>
            <p style="font-size: 11px; color: var(--text-soft);">¬© 2026 Fiore Di Ale.</p>
        </div>

        <div id="discountProgressContainer" class="discount-progress-container">
            <div class="progress-info">
                <span id="progressText">¬°Faltan S/100 para el 10% OFF!</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-track">
                <div id="progressBar" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="whatsapp-float" id="whatsappFloat" onclick="sendOrder()">
            <span class="float-text" id="floatText">Ver Carrito (0)</span>
            <span id="floatTotal" style="font-weight: 700;">S/0.00</span>
        </div>

        <div id="productModal" class="modal" onclick="closeModal(event)">
            <div class="modal-content">
                <div class="close-modal" onclick="closeModal(event)">√ó</div>
                <img src="" id="modalImg" class="modal-img">
                <div class="modal-body">
                    <h2 id="modalTitle" class="modal-title serif-font">Nombre Producto</h2>
                    <div id="modalPrice" class="modal-price">S/0.00</div>
                    <p id="modalDesc" class="modal-desc">Cargando descripci√≥n...</p>
                    <button class="btn-select active" style="padding:15px; width:100%; font-size: 15px;" onclick="closeModal(event)">
                        Seguir viendo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSqdgnG5y9lb3VHDfR7GHDBEW7XQKypCGiAo_-ORNZDwL8p9iiyxi4JWOeij5TauFPdplA083H7D3kX/pub?output=csv';

        let products = [];
        let cart = [];
        let currentCategory = 'all'; 
        let currentSearch = '';
        // Variables para el descuento
        const DISCOUNT_THRESHOLD = 100; // Meta de 100 soles
        const DISCOUNT_PERCENTAGE = 0.10; // 10%

        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                products = csvToJson(text);
                renderProducts('all');
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('productGrid').innerHTML = '<p style="text-align:center; padding:20px; color: var(--fiore-mauve);">No se pudo conectar con el cat√°logo.</p>';
            }
        }

        function csvToJson(csv) {
            const lines = csv.split('\n');
            const result = [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/\r/g, ''));
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i]) continue;
                const obj = {};
                const currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                headers.forEach((header, j) => {
                    let value = currentline[j]?.replace(/\r/g, '').replace(/"/g, '') || '';
                    if (header === 'price' || header === 'oldPrice' || header === 'id') {
                        value = value ? Number(value) : null;
                    }
                    obj[header] = value;
                });
                result.push(obj);
            }
            return result;
        }

        function fixDriveLink(url) {
            if (!url || url.trim() === '') return 'https://via.placeholder.com/400x500?text=Sin+Imagen'; 
            if (url.includes('drive.google.com') && url.includes('/d/')) {
                const id = url.split('/d/')[1].split('/')[0];
                const driveLink = `https://drive.google.com/uc?export=view&id=${id}`;
                return `https://wsrv.nl/?url=${encodeURIComponent(driveLink)}`; 
            }
            return `https://wsrv.nl/?url=${encodeURIComponent(url)}`;
        }

        function renderProducts(categoryOverride) {
            if (categoryOverride) currentCategory = categoryOverride;
            const grid = document.getElementById('productGrid');
            grid.innerHTML = ''; 

            if (products.length === 0) return;

            let filtered = currentCategory === 'all' ? products : products.filter(p => p.category === currentCategory);
            if (currentSearch.length > 0) filtered = filtered.filter(p => p.name && p.name.toLowerCase().includes(currentSearch));

            if (filtered.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--fiore-mauve); margin-top: 40px;">No encontramos resultados.</p>';
                return;
            }

            filtered.forEach(product => {
                const isSelected = cart.includes(product.id);
                const btnClass = isSelected ? 'btn-select active' : 'btn-select';
                const cardClass = isSelected ? 'card selected' : 'card';
                const btnText = isSelected ? 'Quitar' : 'Agregar';

                let tagHTML = '';
                if (product.tag && product.tag.trim() !== '') {
                    const tagClass = product.tag.includes('%') ? 'badge-discount' : 'badge-bestseller';
                    tagHTML = `<div class="badge ${tagClass}">${product.tag}</div>`;
                }

                const oldPriceHTML = product.oldPrice ? `<span class="old-price">S/${product.oldPrice}</span>` : '';
                const imgUrl = fixDriveLink(product.image);

                const card = `
                    <div class="${cardClass} reveal" id="card-${product.id}">
                        <div class="card-image-container" onclick="openModal(${product.id})">
                            ${tagHTML}
                            <img src="${imgUrl}" alt="${product.name}" class="card-img" referrerpolicy="no-referrer">
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">${product.name}</h3>
                            <div class="price-row">
                                <span class="price">S/${product.price}</span>
                                ${oldPriceHTML}
                            </div>
                            <button class="${btnClass}" id="btn-${product.id}" onclick="toggleProduct(${product.id})">${btnText}</button>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
            initScrollReveal();
        }

        function openModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const imgUrl = fixDriveLink(product.image);
            document.getElementById('modalImg').src = imgUrl;
            document.getElementById('modalTitle').innerText = product.name;
            document.getElementById('modalPrice').innerText = 'S/' + product.price;
            const desc = product.description && product.description.trim() !== '' ? product.description : "Detalles exclusivos de Fiore Di Ale. Incluye tarjeta de dedicatoria.";
            document.getElementById('modalDesc').innerText = desc;
            document.getElementById('productModal').style.display = 'flex';
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal') || event.target.classList.contains('close-modal') || event.target.tagName === 'BUTTON') {
                document.getElementById('productModal').style.display = 'none';
            }
        }

        function initScrollReveal() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('visible');
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }

        const slider = document.getElementById('filtersContainer');
        let isDown = false; let startX; let scrollLeft;
        slider.addEventListener('mousedown', (e) => { isDown = true; slider.classList.add('active'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
        slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
        slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); });
        slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 2; slider.scrollLeft = scrollLeft - walk; });

        // --- NUEVA L√ìGICA CENTRALIZADA DEL CARRITO ---
        function toggleProduct(id) {
            const index = cart.indexOf(id);
            if (index === -1) cart.push(id);
            else cart.splice(index, 1);
            
            // Actualizamos todo: productos, barra de progreso y bot√≥n WA
            renderProducts(); 
            updateCartState();
        }

        // Funci√≥n principal que calcula totales y actualiza la UI
        function updateCartState() {
            let total = 0;
            cart.forEach(id => {
                const p = products.find(x => x.id === id);
                if(p) total += p.price;
            });

            // 1. Actualizar Barra de Progreso Gamificada
            const progressContainer = document.getElementById('discountProgressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercentSpan = document.getElementById('progressPercent');

            // Calcular porcentaje (tope 100%)
            let percent = (total / DISCOUNT_THRESHOLD) * 100;
            if (percent > 100) percent = 100;

            progressBar.style.width = `${percent}%`;
            progressPercentSpan.innerText = `${Math.floor(percent)}%`;

            // Mostrar u ocultar barra
            if (cart.length > 0 && total > 0) {
                 progressContainer.classList.add('visible');
            } else {
                 progressContainer.classList.remove('visible');
            }

            // Verificar si se logr√≥ la meta
            if (total >= DISCOUNT_THRESHOLD) {
                progressText.innerHTML = "üéâ ¬°Felicidades! 10% OFF desbloqueado";
                progressContainer.classList.add('achieved');
            } else {
                const remaining = DISCOUNT_THRESHOLD - total;
                progressText.innerText = `Agrega S/${remaining.toFixed(2)} m√°s para 10% OFF`;
                progressContainer.classList.remove('achieved');
            }

            // 2. Actualizar Bot√≥n Flotante de WhatsApp
            const floatBtn = document.getElementById('whatsappFloat');
            const floatText = document.getElementById('floatText');
            const floatTotal = document.getElementById('floatTotal');

            if (cart.length > 0) {
                floatBtn.classList.add('visible');
                floatText.innerText = `Ver Carrito (${cart.length})`;
                floatTotal.innerText = `S/${total.toFixed(2)}`;
            } else {
                floatBtn.classList.remove('visible');
            }
        }

        // --- NUEVA L√ìGICA DE ENV√çO CON DESCUENTO ---
        function sendOrder() {
            if (cart.length === 0) return;
            
            let message = "Hola Fiore Di Ale, deseo pedir:%0A%0A";
            let subtotal = 0;
            
            cart.forEach(id => {
                const p = products.find(x => x.id === id);
                if(p) { 
                    message += `‚ñ™Ô∏è ${p.name} (S/${p.price})%0A`;
                    subtotal += p.price; 
                }
            });

            let finalTotal = subtotal;
            let discountAmount = 0;

            // Aplicar descuento si corresponde
            if (subtotal >= DISCOUNT_THRESHOLD) {
                discountAmount = subtotal * DISCOUNT_PERCENTAGE;
                finalTotal = subtotal - discountAmount;
                
                message += `%0A*Subtotal: S/${subtotal.toFixed(2)}*`;
                message += `%0A*üéâ Descuento (10%): -S/${discountAmount.toFixed(2)}*`;
            }

            message += `%0A*TOTAL FINAL: S/${finalTotal.toFixed(2)}*`;
            
            window.open(`https://wa.me/51977414678?text=${message}`, '_blank');
        }

        function checkBusinessHours() {
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            const statusDiv = document.getElementById('businessStatus');
            const statusText = document.getElementById('statusText');
            // Lunes a S√°bado (1-6), de 9am a 8pm (20:00)
            const isOpen = (day >= 1 && day <= 6) && (hour >= 9 && hour < 20);
            if (isOpen) {
                statusDiv.className = 'status-badge status-open';
                statusText.innerText = 'Abierto ahora';
            } else {
                statusDiv.className = 'status-badge status-closed';
                statusText.innerText = 'Cerrado / Pedidos para ma√±ana';
            }
        }

        function filterProducts(cat, element) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            renderProducts(cat);
        }
        function handleSearch() {
            const input = document.getElementById('searchInput');
            currentSearch = input.value.toLowerCase();
            renderProducts();
        }
        function scrollContainer(d) { document.getElementById('filtersContainer').scrollBy({ left: d * 100, behavior: 'smooth' }); }

        loadData();
        checkBusinessHours();
        setInterval(checkBusinessHours, 60000);
    </script>
</body>
</html>
